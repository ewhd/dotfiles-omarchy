#!/usr/bin/env bash

# Start daemon if not running
if ! emacsclient -e "(+ 0 0)" &>/dev/null; then
    emacs --daemon
    # Wait until the server is ready
    until emacsclient -e "(+ 0 0)" &>/dev/null; do
        sleep 0.05
    done
fi

# If the command is to start server by calling emacs --daemon,
# pass the command as is.
for arg in "$@"; do
    if [[ "$arg" == --daemon || "$arg" == --daemon=* ]]; then
        exec /usr/bin/emacs "$@"
    fi
done

# Open client frame, fallback if something is truly wrong
# If running in terminal, open emacsclient in the terminal
# is server is running, and emacs in the terminal otherwise.
# If not running in a terminal, attempt to start emacsclient
# and fall back to emacs if that fails.
if [[ -t 1 ]]; then  # if run from terminal
    if emacsclient -e "(+ 0 0)" &>/dev/null; then
	emacsclient -nw "$@"
    else
	emacs -nw "$@"
    fi
else
    emacsclient -c -a "emacs" "$@"
fi

#!/bin/sh
# run_apply-ansible-setup.sh.tmpl
set -e

{{ if eq .chezmoi.os "linux" }}
    echo "Detected Linux system — preparing to apply Ansible setup..."

    if ! command -v ansible >/dev/null 2>&1; then
        echo "Installing Ansible..."
        if command -v pacman >/dev/null 2>&1; then
            sudo pacman -Sy --noconfirm ansible
        elif command -v apt >/dev/null 2>&1; then
            sudo apt update && sudo apt install -y ansible
        elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y ansible
        else
            echo "Unsupported package manager: cannot install Ansible automatically." >&2
            exit 1
        fi
    fi

    PLAYBOOK="{{ .chezmoi.sourceDir }}/playbooks/main.yaml"
    STAMP="$HOME/.local/state/chezmoi/last-ansible-run.stamp"

    should_run=false
    if [ ! -f "$STAMP" ]; then
        should_run=true
    elif find "{{ .chezmoi.sourceDir }}/playbooks" -newer "$STAMP" | grep -q .; then
        should_run=true
    fi

    if [ "$should_run" = true ]; then
        echo "Detected changes in playbooks — running Ansible setup..."
        export ANSIBLE_CONFIG=$HOME/.local/share/chezmoi/playbooks/ansible.cfg
	ansible-galaxy install -r $HOME/.local/share/chezmoi/playbooks/requirements.yaml
        ansible-playbook --ask-become-pass "$PLAYBOOK"
        mkdir -p "$(dirname "$STAMP")"
        touch "$STAMP"
    else
        echo "No Ansible-related changes detected — skipping setup."
    fi
{{ else }}
    echo "Skipping Ansible setup (not a Linux system)."
{{ end }}
